name: WebApp (JS) - Edge

on:
  push:
    paths:
    - '.github/workflows/webapp-edge.yml'
    - 'source/WebApp/**'
  pull_request:

jobs:
  build:
    name: Build
    # https://github.community/t/duplicate-checks-on-push-and-pull-request-simultaneous-event/18012/5
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: source/WebApp
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'true'

      - uses: actions/setup-node@v1
        with:
          node-version: '12.16.1'

      - run: npm install -g npm@7.22.0

      - run: 'git show ${{ github.sha }} --format="::set-output name=version_number::%cd" --date=format:%Y-%m-%d-%H%M --no-patch'
        id: version

      - name: Run npm ci (mirrorsharp)
        run: npm ci
        working-directory: source/#external/mirrorsharp/WebAssets
        
      - name: Run npm run build (mirrorsharp)
        run: npm run build
        working-directory: source/#external/mirrorsharp/WebAssets

      - name: Run npm install --production (mirrorsharp/dist)
        run: npm install --production
        working-directory: source/#external/mirrorsharp/WebAssets/dist

      - run: npm ci      
      
      # DEBUG
      - run: readlink -f ls /home/runner/work/SharpLab/SharpLab/source/WebApp/node_modules/mirrorsharp
      - run: ls /home/runner/work/SharpLab/SharpLab/source/WebApp/node_modules/mirrorsharp
      
      - run: npm run build-ci
        env:
          NODE_ENV: ci
          SHARPLAB_WEBAPP_BUILD_VERSION: ${{ steps.version.outputs.version_number }}

      - run: npm test

      - uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: __diff_output__
          path: source/WebApp/tests/rendering/__image_snapshots__/__diff_output__
          if-no-files-found: ignore

      - run: npm test rendering -- --updateSnapshot
        if: failure()

      - uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: '__image_snapshots__ (updated)'
          path: source/WebApp/tests/rendering/__image_snapshots__
          if-no-files-found: ignore

      - uses: actions/upload-artifact@v2
        with:
          name: WebApp
          path: source/WebApp/WebApp.zip
          if-no-files-found: error

      - uses: actions/create-release@v1
        if: github.ref == 'refs/heads/main'
        id: create_release
        with:
          tag_name: webapp-release-${{ steps.version.outputs.version_number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/upload-release-asset@v1
        if: github.ref == 'refs/heads/main'
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./source/WebApp/WebApp.zip
          asset_name: WebApp.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-to-edge:
    name: Deploy (Edge)
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: edge-webapp
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: WebApp

      - run: Expand-Archive WebApp.zip ./WebApp
        shell: pwsh

      - run: Rename-Item ./WebApp/latest latest-edge
        shell: pwsh

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Run azure/CLI@v1: az storage blob upload-batch"
        uses: azure/CLI@v1
        with:
          azcliversion: 2.9.1
          inlineScript: |
            az storage blob upload-batch --account-name slpublic -d assets -s WebApp

      - run: Invoke-RestMethod -Method POST -Uri 'https://edge.sharplab.io/assets/reload' -Authentication Bearer -Token $(ConvertTo-SecureString $env:SHARPLAB_ASSETS_RELOAD_TOKEN -AsPlainText)
        shell: pwsh
        env:
          SHARPLAB_ASSETS_RELOAD_TOKEN: ${{ secrets.SHARPLAB_ASSETS_RELOAD_TOKEN }}